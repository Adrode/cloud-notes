#sqlalchemy
## Czym jest SQLAlchemy?
#sqlalchemy 
- **SQLAlchemy** - składa się z toolkita SQL do Pythona (sqlalchemy core) oraz z ORM (Object Relational Mapper).
	- ORM czyli obsługa SQL z poziomu Pythona, za pomocą obiektów, gdzie klasy reprezentują tablice
	- przykładowy kod
```python
from sqlalchemy import create_engine, Integer, String, Float, Column, ForeignKey
from sqlalchemy.orm import declarative_base, sessionmaker, relationship

engine = create_engine('postgresql+psycopg2://postgres:postgres@localhost:5432/satutorialdatabase', echo=True)

Base = declarative_base()

class Person(Base):
	__tablename__ = 'people'
	id = Column(Integer, primary_key=True)
	name = Column(String, nullable=False)
	age = Column(Integer)
	
	things = relationship('Thing', back_populates='person')
	
class Thing(Base):
	__tablename__ = 'things'
	id = Column(Integer, primary_key=True)
	description = Column(String, nullable=False)
	value = Column(Float)
	owner = Column(Integer, ForeignKey('people.id'))
```

## Jak zainstalować SQLAlchemy?
#sqlalchemy 
- Instalacja za pomocą pip:
	- `pip install sqlalchemy`

## Jakie są podstawy SQLAlchemy Core?
#sqlalchemy #core #sqlite
- **SQLite** - to plik i biblioteka
	- plik `.db` przechowuje bazę danych (tabele, constrainty, relacje, itd.)
	- biblioteka `SQLite` obsługuje bazę (czyta i zapisuje dane, parsuje i wykonuje SQL, zarządza transakcjami)
		- `sqlite3 nazwa_bazy.db` - w ten sposób można wejść do powłoki (terminal) biblioteki sqlite
```python
from sqlalchemy import create_engine, text

engine = create_engine('sqlite:///mydatabase.db', echo=True)
...
```
- `engine` - tworzy centralny obiekt SQLAlchemy (przez `create-engine`), czyli:
	- trzyma informacje jak połączyć się z bazą
	- zarządza połączeniem z bazą danych
	- wysyła SQL do bazy
- `sqlite:///mydatabase.db` - URL bazy danych:
	- `sqlite` - typ bazy danych
	- `:///` - lokalny plik
	- `mydatabase.db` - plik bazy danych
- `echo=True` - wyświetla generowane zapytania SQL do konsoli
	- bardzo przydatne do debugowania i nauki
```python
...
conn = engine.connect()

conn.execute(text("CREATE TABLE IF NOT EXISTS people (name str, age int)"))

conn.commit()
```
- `engine.connect()` - nawiązanie połączenia między Pythonem a bazą danych
- `conn.execute(text(SQL query))` - wykonanie zapytania SQL
	- jednocześnie ten .execute() otwiera transakcję
- `conn.commit()` - zamknięcie transakcji, zapisanie zmian

```python
from sqlalchemy import create_engine, MetaData, Table, Column, Integer, String

engine = create_engine('sqlite:///mydatabase.db', echo=True)

meta = MetaData()

people = Table(
	"people",
	meta,
	Column('id', Integer, primary_key=True),
	Column('name', String, nullable=False),
	Column('age', Integer)
)

meta.create_all(engine)
```
- `meta = MetaData()` - `meta` jest obiektem, który przechowuje opis struktury bazy danych
	- jakie są tabele, kolumny, typy danych, primary keys i foreign keys, constraints, itd.
	- w powyższym przypadku `people` to definicja tabeli, a `meta` przechowuje dane na temat tej tabeli (oraz innych, jeśli inne tabele by istniały)
- `meta.create_all(engine)` - na podstawie informacji o tablicach w `meta` tworzy requesty do bazy danych, które utworzą te tabele

skończone na 15:33
https://www.youtube.com/watch?v=529LYDgRTgQ


- **Session** w ORM:
```python
from sqlalchemy.orm import Session

engine = create_engine('sqlite:///mydatabase.db', echo=True)
session = Session(engine)

session.execute(text('INSERT INTO people (name, age) VALUES ("Mike", 30);'))

session.commit()
```